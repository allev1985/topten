# Data Model: Verify-Email Page

**Feature**: Fix Verify-Email Page to Handle Verification Code  
**Date**: 2025-11-30

## Overview

This feature enhances the verify-email page without introducing new database entities. The data model focuses on UI state management and server action contracts.

---

## Page State Model

### VerificationPageState

The verify-email page can be in one of four states:

```typescript
type VerificationPageState = 
  | 'pending'    // No code in URL - show check email instructions
  | 'verifying'  // Code present, attempting verification
  | 'success'    // Verification succeeded
  | 'error';     // Verification failed
```

### State Transitions

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│    URL has no code         URL has code                     │
│         │                      │                            │
│         ▼                      ▼                            │
│    ┌─────────┐            ┌───────────┐                     │
│    │ PENDING │            │ VERIFYING │                     │
│    └─────────┘            └─────┬─────┘                     │
│                                 │                           │
│               ┌─────────────────┴─────────────────┐         │
│               │                                   │         │
│               ▼                                   ▼         │
│          ┌─────────┐                         ┌───────┐      │
│          │ SUCCESS │ ──(redirect)──►         │ ERROR │      │
│          └─────────┘    /dashboard           └───┬───┘      │
│                                                  │          │
│                                                  │          │
│                           Resend ────────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## URL Parameters

### Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `code` | string | Conditional | PKCE authorization code from verification email |
| `token_hash` | string | Conditional | OTP token hash from verification email |
| `type` | string | Conditional | Token type (must be "email" for OTP flow) |

Note: Either `code` OR (`token_hash` + `type`) must be present for verification to occur.

### Example URLs

These URLs are generated by Supabase and embedded in verification emails. Users click these links from their email:

```
# OTP-based verification (from verification email)
/verify-email?token_hash=abc123&type=email

# PKCE-based verification (from verification email)
/verify-email?code=xyz789

# Pending state (direct navigation, no verification code)
/verify-email
```

---

## Server Action Contracts

### VerifyEmailSuccessData

```typescript
/**
 * Success data returned by email verification action
 */
export interface VerifyEmailSuccessData {
  /** Success message to display */
  message: string;
  /** Target URL for redirect after success */
  redirectTo: string;
}
```

### ResendVerificationSuccessData

```typescript
/**
 * Success data returned by resend verification action
 */
export interface ResendVerificationSuccessData {
  /** Success message (same regardless of email existence) */
  message: string;
}
```

---

## Component Props

### VerifyEmailPageProps

```typescript
interface VerifyEmailPageProps {
  searchParams: Promise<{
    code?: string;
    token_hash?: string;
    type?: string;
  }>;
}
```

### VerificationResultProps

```typescript
interface VerificationResultProps {
  /** Whether verification succeeded */
  isSuccess: boolean;
  /** Error message if verification failed */
  error?: string;
  /** Success message if verification succeeded */
  message?: string;
}
```

### ResendFormProps

```typescript
interface ResendFormProps {
  /** Optional error message from previous attempt */
  error?: string;
}
```

---

## Validation Rules

### URL Parameter Validation

1. **Code validation** (PKCE flow):
   - Must be a non-empty string
   - Validated using existing `verifyCodeSchema` from `@/schemas/auth`

2. **Token validation** (OTP flow):
   - `token_hash` must be a non-empty string
   - `type` must equal "email"
   - Validated using existing `verifyTokenSchema` from `@/schemas/auth`

### Resend Form Validation

1. **Email validation**:
   - Required field
   - Must be valid email format
   - Trimmed and lowercased
   - Uses existing email validation pattern from `passwordResetSchema`

---

## Error Types

Reuses existing error infrastructure from `@/lib/auth/errors.ts`:

| Error Code | HTTP Status | User Message |
|------------|-------------|--------------|
| `INVALID_TOKEN` | 400 | "This verification link is invalid. Please request a new one." |
| `EXPIRED_TOKEN` | 400 | "This verification link has expired. Please request a new one." |
| `SERVER_ERROR` | 500 | "An unexpected error occurred. Please try again." |

---

## Integration Points

### Supabase Auth Methods

| Method | Flow | Description |
|--------|------|-------------|
| `verifyOtp()` | OTP | Verifies email using token_hash |
| `exchangeCodeForSession()` | PKCE | Exchanges code for session |
| `resend()` | Resend | Sends new verification email |

### Existing Components/Utilities

| Component/Utility | Usage |
|-------------------|-------|
| `Card`, `CardHeader`, etc. | UI container (shadcn/ui) |
| `Button`, `Input`, `Label` | Form elements (shadcn/ui) |
| `Alert`, `AlertDescription` | Error display (shadcn/ui) |
| `useFormState` hook | Form state management |
| `ActionState<T>` type | Server action response type |
| `createClient()` | Supabase server client |
| `REDIRECT_ROUTES` | Redirect path constants |

---

## Security Considerations

1. **Token exposure**: Tokens appear in URL but are one-time use
2. **User enumeration**: Resend action returns same message regardless of email existence
3. **Server-side processing**: All verification happens server-side, not in client
4. **CSRF protection**: Server actions have built-in CSRF protection via Next.js
