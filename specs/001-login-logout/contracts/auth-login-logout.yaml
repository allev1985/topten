openapi: 3.1.0
info:
  title: YourFavs Authentication API - Login & Logout
  description: API contracts for login and logout endpoints
  version: 1.0.0

servers:
  - url: /api/auth
    description: Auth API base path

paths:
  /login:
    post:
      summary: User Login
      description: |
        Authenticates a user with email and password credentials.
        On success, creates a session and sets secure HTTP-only cookies.
        Returns a validated redirect URL for client-side navigation.
        
        **User Enumeration Protection**: Returns identical error response
        for both invalid email and wrong password scenarios.
      operationId: login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              basic:
                summary: Basic login
                value:
                  email: user@example.com
                  password: SecurePass123!
              withRedirect:
                summary: Login with redirect
                value:
                  email: user@example.com
                  password: SecurePass123!
                  redirectTo: /lists/my-favorites
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Session cookies (managed by Supabase SSR)
              schema:
                type: string
                example: sb-xxx-auth-token=...; HttpOnly; Secure; SameSite=Lax
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginSuccessResponse'
              example:
                success: true
                redirectTo: /dashboard
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              example:
                success: false
                error:
                  code: VALIDATION_ERROR
                  message: Validation failed
                  details:
                    - field: email
                      message: Invalid email format
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'
              examples:
                invalidCredentials:
                  summary: Invalid email or password
                  value:
                    success: false
                    error:
                      code: AUTH_ERROR
                      message: Invalid email or password
                unverifiedEmail:
                  summary: Email not verified
                  value:
                    success: false
                    error:
                      code: AUTH_ERROR
                      message: Please verify your email before logging in
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'
              example:
                success: false
                error:
                  code: SERVER_ERROR
                  message: An unexpected error occurred

  /logout:
    post:
      summary: User Logout
      description: |
        Invalidates the current user session and clears all session cookies.
        This endpoint is idempotent - calling it without an active session
        still returns a success response.
      operationId: logout
      tags:
        - Authentication
      responses:
        '200':
          description: Logout successful
          headers:
            Set-Cookie:
              description: Cleared session cookies
              schema:
                type: string
                example: sb-xxx-auth-token=; Max-Age=0; HttpOnly; Secure; SameSite=Lax
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutSuccessResponse'
              example:
                success: true
                message: Logged out successfully
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'
              example:
                success: false
                error:
                  code: SERVER_ERROR
                  message: An unexpected error occurred

components:
  schemas:
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address (trimmed and lowercased)
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 1
          description: User's password
          example: SecurePass123!
        redirectTo:
          type: string
          description: |
            Optional redirect URL after successful login.
            Must be a relative path starting with '/'.
            Invalid URLs are silently replaced with '/dashboard'.
          example: /lists/my-favorites

    LoginSuccessResponse:
      type: object
      required:
        - success
        - redirectTo
      properties:
        success:
          type: boolean
          enum: [true]
        redirectTo:
          type: string
          description: Validated redirect URL
          example: /dashboard

    LogoutSuccessResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          enum: [true]
        message:
          type: string
          example: Logged out successfully

    ValidationErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [VALIDATION_ERROR]
            message:
              type: string
              example: Validation failed
            details:
              type: array
              items:
                $ref: '#/components/schemas/ErrorDetail'

    AuthErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [AUTH_ERROR]
            message:
              type: string
              description: Generic error message to prevent user enumeration
              example: Invalid email or password

    ServerErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [SERVER_ERROR]
            message:
              type: string
              example: An unexpected error occurred

    ErrorDetail:
      type: object
      required:
        - field
        - message
      properties:
        field:
          type: string
          description: Field name that failed validation
          example: email
        message:
          type: string
          description: Human-readable error message
          example: Invalid email format

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sb-xxx-auth-token
      description: Supabase session cookie (automatically managed)

tags:
  - name: Authentication
    description: User authentication endpoints for login and logout
