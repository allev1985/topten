openapi: 3.0.3
info:
  title: Multi-Auth Password Reset API
  description: |
    API for updating user passwords with multiple authentication methods.
    Supports PKCE code, OTP token, and session-based authentication.
  version: 1.0.0

paths:
  /api/auth/password:
    put:
      summary: Update user password
      description: |
        Updates the authenticated user's password. Supports multiple authentication methods
        in priority order: PKCE code → OTP token → existing session.

        After successful password update, the user is automatically signed out.
      operationId: updatePassword
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasswordUpdateRequest"
            examples:
              pkceCode:
                summary: Password reset with PKCE code
                value:
                  password: "NewSecurePass123!"
                  code: "pkce_authorization_code_from_email"
              otpToken:
                summary: Password reset with OTP token
                value:
                  password: "NewSecurePass123!"
                  token_hash: "otp_token_hash_from_email"
                  type: "email"
              sessionAuth:
                summary: Password change for authenticated user
                value:
                  password: "NewSecurePass123!"
      responses:
        "200":
          description: Password updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
              example:
                success: true
                message: "Password updated successfully"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
              example:
                success: false
                error:
                  code: "VALIDATION_ERROR"
                  message: "Validation failed"
                  details:
                    - field: "password"
                      message: "Password must be at least 12 characters"
        "401":
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthErrorResponse"
              examples:
                noAuth:
                  summary: No valid authentication
                  value:
                    success: false
                    error:
                      code: "AUTH_ERROR"
                      message: "Authentication required"
                expiredCode:
                  summary: Expired code/token
                  value:
                    success: false
                    error:
                      code: "AUTH_ERROR"
                      message: "Authentication link has expired. Please request a new one."
                invalidCode:
                  summary: Invalid code/token
                  value:
                    success: false
                    error:
                      code: "AUTH_ERROR"
                      message: "Authentication failed"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerErrorResponse"
              example:
                success: false
                error:
                  code: "SERVER_ERROR"
                  message: "An unexpected error occurred"

components:
  schemas:
    PasswordUpdateRequest:
      type: object
      required:
        - password
      properties:
        password:
          type: string
          format: password
          minLength: 12
          description: |
            New password. Must meet all requirements:
            - Minimum 12 characters
            - At least one uppercase letter
            - At least one lowercase letter
            - At least one number
            - At least one special character
          example: "NewSecurePass123!"
        code:
          type: string
          description: PKCE authorization code from password reset email link
          example: "pkce_code_123"
        token_hash:
          type: string
          description: OTP token hash from password reset email
          example: "token_hash_abc"
        type:
          type: string
          enum: [email]
          description: Token type for OTP verification. Required when token_hash is provided.
          example: "email"

    SuccessResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          enum: [true]
        message:
          type: string

    ValidationErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [VALIDATION_ERROR]
            message:
              type: string
            details:
              type: array
              items:
                type: object
                required:
                  - field
                  - message
                properties:
                  field:
                    type: string
                  message:
                    type: string

    AuthErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [AUTH_ERROR]
            message:
              type: string

    ServerErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum: [SERVER_ERROR]
            message:
              type: string

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sb-access-token
      description: Supabase session cookie (for session-based auth)

# Note: Security is handled within the endpoint logic, not at API gateway level.
# The endpoint accepts three authentication methods:
# 1. PKCE code in request body (no cookie required)
# 2. OTP token_hash + type in request body (no cookie required)
# 3. Session cookie (cookieAuth)
# At least one valid authentication method must be provided.
